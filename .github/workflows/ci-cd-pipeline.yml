name: ci-cd-pipeline

on:
  push:
    branches:
      - develop      # → dev
      - staging      # → staging
      - main         # → prod
  pull_request:
    branches:
      - develop
      - staging
      - main

env:
  APP_NAME: "mynewdemo"
  AWS_REGION: "us-east-1"

jobs:
  # ------------------------------------------------
  # 1) CI: Lint & Test
  # ------------------------------------------------
  lint_test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run lint & tests (placeholder)
        run: |
          echo "Running lint & tests for $APP_NAME ..."
          echo "Lint OK, tests OK (placeholder)."

  # ------------------------------------------------
  # 2) CD: Deploy to ECS (dev / staging / prod)
  # ------------------------------------------------
  deploy:
    needs: lint_test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Decide which environment / cluster / service to target
      - name: Select environment based on branch
        id: envselect
        run: |
          BRANCH="${GITHUB_REF##*/}"
          echo "Branch is: $BRANCH"

          if [[ "$BRANCH" == "develop" ]]; then
            echo "env=dev" >> $GITHUB_OUTPUT
            echo "cluster=mynewdemo-dev-cluster" >> $GITHUB_OUTPUT
            echo "service=mynewdemo-dev-service" >> $GITHUB_OUTPUT

          elif [[ "$BRANCH" == "staging" ]]; then
            echo "env=staging" >> $GITHUB_OUTPUT
            echo "cluster=mynewdemo-staging-cluster" >> $GITHUB_OUTPUT
            echo "service=mynewdemo-staging-service" >> $GITHUB_OUTPUT

          elif [[ "$BRANCH" == "main" ]]; then
            echo "env=prod" >> $GITHUB_OUTPUT
            echo "cluster=mynewdemo-prod-cluster" >> $GITHUB_OUTPUT
            echo "service=mynewdemo-prod-service" >> $GITHUB_OUTPUT

          else
            echo "Unsupported branch for deployment: $BRANCH"
            exit 1
          fi

      - name: Deploy to ECS
        run: |
          ENVIRONMENT="${{ steps.envselect.outputs.env }}"
          CLUSTER="${{ steps.envselect.outputs.cluster }}"
          SERVICE="${{ steps.envselect.outputs.service }}"

          echo "Environment : $ENVIRONMENT"
          echo "Cluster     : $CLUSTER"
          echo "Service     : $SERVICE"

          aws ecs update-service \
            --cluster "$CLUSTER" \
            --service "$SERVICE" \
            --force-new-deployment
